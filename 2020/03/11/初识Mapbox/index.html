<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"lastvigo.github.io","root":"/","scheme":"Muse","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="了解和使用mapbox构建应用">
<meta property="og:type" content="article">
<meta property="og:title" content="初识Mapbox">
<meta property="og:url" content="https://lastvigo.github.io/2020/03/11/%E5%88%9D%E8%AF%86Mapbox/index.html">
<meta property="og:site_name" content="Vigo&#39;s Blog">
<meta property="og:description" content="了解和使用mapbox构建应用">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-03-11T12:39:33.000Z">
<meta property="article:modified_time" content="2020-03-11T12:57:07.340Z">
<meta property="article:author" content="Vigo">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://lastvigo.github.io/2020/03/11/%E5%88%9D%E8%AF%86Mapbox/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>初识Mapbox | Vigo's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Vigo's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://lastvigo.github.io/2020/03/11/%E5%88%9D%E8%AF%86Mapbox/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Vigo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Vigo's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          初识Mapbox
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-03-11 20:39:33 / 修改时间：20:57:07" itemprop="dateCreated datePublished" datetime="2020-03-11T20:39:33+08:00">2020-03-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">编程</span></a>
                </span>
            </span>

          
            <div class="post-description">了解和使用mapbox构建应用</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="突如其来"><a href="#突如其来" class="headerlink" title="突如其来"></a>突如其来</h1><p>2020年2月初，发现公司使用谷歌地图功能的网页和后台功能出现异常。排查过后发现问题在于网络咱解决不了。所以暂时屏蔽了相关功能，着手更换。</p>
<p>听闻业内企业换成了mapbox，决定一试，本文回顾了这个过程。</p>
<h1 id="了解mapbox"><a href="#了解mapbox" class="headerlink" title="了解mapbox"></a>了解mapbox</h1><p>mapbox成立于2010年，是一个提供地图相关服务的平台。从他的开发文档中提供的变更记录中我们能够发现mapbox最近正在快速的迭代产品。通常这表明了两个信息：</p>
<ol>
<li>发展势头不错。</li>
<li>产品尚未完善。</li>
</ol>
<p>技术开发更关心第二条，这次的经历也印证了这个推断。</p>
<h2 id="选择关注的内容"><a href="#选择关注的内容" class="headerlink" title="选择关注的内容"></a>选择关注的内容</h2><p>mapbox提供了线上的服务，在此基础上还提供了针对不同平台的开发SDK。</p>
<p>因为我们是java后端的web网站，前端代码修改选择看javascript的在<a href="https://www.mapbox.cn/mapbox-gl-js/overview/" target="_blank" rel="noopener">这里</a>，java后端在<a href="https://docs.mapbox.com/android/java/overview/" target="_blank" rel="noopener">这里</a>，在<a href="https://github.com/mapbox" target="_blank" rel="noopener">Github</a>上不止有这些。</p>
<h3 id="前端js的选择"><a href="#前端js的选择" class="headerlink" title="前端js的选择"></a>前端js的选择</h3><p>个人理解目前js部分正在做切换，官方在醒目的位置推荐的是mapbox-gl这个项目，但是在<a href="https://docs.mapbox.com/mapbox.js/api/v3.2.1/" target="_blank" rel="noopener">另外一处</a>你能找到另外一个版本，使用到了mapbox.js<a href="http://leafletjs.com/" target="_blank" rel="noopener">和Leaflet</a>，在booking的地图中我们也找到了Leaflet的印记。最开始我们因为没有找到后面这个版本（搜索引擎也没搜到），所以径直选用了mapbox-gl。</p>
<h3 id="后端java的选择"><a href="#后端java的选择" class="headerlink" title="后端java的选择"></a>后端java的选择</h3><p>如果你是maven项目，添加以下的依赖信息即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.mapbox.mapboxsdk&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mapbox-sdk-services&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.0.0&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p>项目在上方的github地址中都能找到。</p>
<h1 id="实现细节"><a href="#实现细节" class="headerlink" title="实现细节"></a>实现细节</h1><h2 id="地图初始化"><a href="#地图初始化" class="headerlink" title="地图初始化"></a>地图初始化</h2><p>在指定的html节点内容创建地图对象，设置了地图的外观、中心点，缩放度量，同时将地图上的地名文字设置为中文，添加必要的操作控件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">   let initMap&#x3D;function(mapContainerId)&#123;</span><br><span class="line">	&#x2F;&#x2F; 1.清除html节点容器内的内容</span><br><span class="line">	$(&#39;#&#39;+mapContainerId).html(&quot;&quot;);</span><br><span class="line">	&#x2F;&#x2F; 2.构造map对象</span><br><span class="line">	mapboxgl.accessToken &#x3D;mapboxToken.token;</span><br><span class="line">       const map &#x3D; new mapboxgl.Map(&#123;</span><br><span class="line">           container: mapContainerId,</span><br><span class="line">           style: &quot;mapbox:&#x2F;&#x2F;styles&#x2F;mapbox&#x2F;streets-v9&quot;,</span><br><span class="line">           center: [16.367817,48.215319],</span><br><span class="line">           zoom: 8</span><br><span class="line">       &#125;);</span><br><span class="line">       &#x2F;&#x2F;3.设置地图语言为中文</span><br><span class="line">       &#x2F;&#x2F; 1)尚未做设置的情况方可进行设置</span><br><span class="line">       if(mapboxgl.getRTLTextPluginStatus()&#x3D;&#x3D;&quot;unavailable&quot;)&#123;</span><br><span class="line">     &#x2F;&#x2F; 英文标注转换为中文   </span><br><span class="line">        mapboxgl.setRTLTextPlugin(</span><br><span class="line">            &quot;https:&#x2F;&#x2F;api.mapbox.com&#x2F;mapbox-gl-js&#x2F;plugins&#x2F;mapbox-gl-rtl-text&#x2F;v0.1.0&#x2F;mapbox-gl-rtl-text.js&quot;</span><br><span class="line">        );</span><br><span class="line">       &#125;</span><br><span class="line">       &#x2F;&#x2F; 2)设置语言</span><br><span class="line">       var language &#x3D; new MapboxLanguage(&#123;</span><br><span class="line">           defaultLanguage: &quot;zh&quot;</span><br><span class="line">       &#125;);</span><br><span class="line">       map.addControl(language);</span><br><span class="line">       &#x2F;&#x2F;4.添加界面控件</span><br><span class="line">       &#x2F;&#x2F; 1)全屏</span><br><span class="line">       map.addControl(new mapboxgl.FullscreenControl());</span><br><span class="line">       &#x2F;&#x2F; 2)地图导航</span><br><span class="line">       var nav &#x3D; new mapboxgl.NavigationControl();</span><br><span class="line">       map.addControl(nav);</span><br><span class="line">       return map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里 map的style决定了地图的的贴图外观，还有如下的值备选：</p>
<ul>
<li>mapbox://styles/mapbox/streets-v11</li>
<li>mapbox://styles/mapbox/outdoors-v11</li>
<li>mapbox://styles/mapbox/light-v10</li>
<li>mapbox://styles/mapbox/dark-v10</li>
<li>mapbox://styles/mapbox/satellite-v9</li>
<li>mapbox://styles/mapbox/satellite-streets-v11</li>
<li>mapbox://styles/mapbox/navigation-preview-day-v4</li>
<li>mapbox://styles/mapbox/navigation-preview-night-v4</li>
<li>mapbox://styles/mapbox/navigation-guidance-day-v4</li>
<li>mapbox://styles/mapbox/navigation-guidance-night-v4</li>
</ul>
<h2 id="根据经纬度在地图上标点并显示"><a href="#根据经纬度在地图上标点并显示" class="headerlink" title="根据经纬度在地图上标点并显示"></a>根据经纬度在地图上标点并显示</h2><p>提供标点的坐标和名称信息，在地图上创建对应的标记点。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">let putCityMarkerOnMap&#x3D;function(element,map)&#123;</span><br><span class="line">	var el &#x3D; document.createElement(&#39;div&#39;);</span><br><span class="line">       el.className &#x3D; &#39;cMarker_city&#39;;</span><br><span class="line">       let m &#x3D; new mapboxgl.Marker(el, &#123;</span><br><span class="line">               offset: [0, -20]</span><br><span class="line">           &#125;)</span><br><span class="line">       .setLngLat(element.center)</span><br><span class="line">       .setPopup(new mapboxgl.Popup(&#123;</span><br><span class="line">                     offset: 25</span><br><span class="line">                 &#125;) &#x2F;&#x2F; add popups</span><br><span class="line">                 .setHTML(&#39;&lt;div class&#x3D;&quot;cMarkerPop&quot;&gt;&#39; + element.text + &#39;&lt;&#x2F;div&gt;&#39;))</span><br><span class="line">       .addTo(map);</span><br><span class="line">       &#x2F;&#x2F; 存储创建的标记点</span><br><span class="line">       city_marker_list.push(m);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上面代码中创建了自定义外观的标记点，这段代码需要和一个名称为<strong>cMarker_city</strong>的class class配合才可以生效。如果不使用自定的标记点，直接使用<code>new mapboxgl.Marker()</code>就可以了。</p>
<p>另外，标记点上附加了一个点击弹出框。</p>
<p>在最后把创建的标记点存入了一个容器，这样做的目的是为了在需要的时候清除地图上的所有标记点。类似下面这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">   while(city_marker_list.length&gt;0)&#123;</span><br><span class="line">	let m&#x3D;city_marker_list.pop();</span><br><span class="line">	m.remove();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到此，你可以做到标记点的摆放和清除了，然而很可能你看不到他们。因为很可能他们不在地图的视野范围内。当然你可以调用<code>map.setCenter([-74, 38]);</code>设置当前地图的中心点，但是实际情况可能存在多个标记点，而且你还要需要比较恰当的把他们都在地图视野内的显示完全。那么试试下面的方法吧：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">   &#x2F;**</span><br><span class="line"> * 让地图能完整显示所有的坐标点</span><br><span class="line"> *&#x2F;</span><br><span class="line">let setBounds&#x3D;function(arr,map)&#123;</span><br><span class="line">	let first &#x3D; new mapboxgl.LngLat(arr[0].lng, arr[0].lat);</span><br><span class="line">   	let bounds &#x3D; new mapboxgl.LngLatBounds(first, first);</span><br><span class="line">   	if(arr.length&gt;1)&#123;</span><br><span class="line">   		for(var index&#x3D;1;index&lt;arr.length-1;index++)&#123;</span><br><span class="line">   			let newPoint&#x3D;new mapboxgl.LngLat(arr[index].lng, arr[index].lat);</span><br><span class="line">   			bounds.extend(newPoint);</span><br><span class="line">   		&#125;</span><br><span class="line">   	&#125;</span><br><span class="line">   	map.fitBounds(bounds, &#123;</span><br><span class="line">			 padding: 100&#x2F;&#x2F; 控制要显示的点距离地图视野有100像素</span><br><span class="line">			 &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法中<code>map.fitBounds</code>是关键，之前都是参数准备。</p>
<h2 id="根据地名显示行程路线"><a href="#根据地名显示行程路线" class="headerlink" title="根据地名显示行程路线"></a>根据地名显示行程路线</h2><p>提供的是数个城市名称，需要在地图上根据他们的顺序绘制导航路线。</p>
<p>这个操作需要需要请求导航线路，需要用到另外的js类库：<a href="https://github.com/mapbox/mapbox-sdk-js" target="_blank" rel="noopener">mapbox-sdk-js</a>,这个类库封装了一系列的请求，你可以通过它来设置参数，发送请求看得到结果。详细的列表在<a href="https://github.com/mapbox/mapbox-sdk-js/blob/master/docs/services.md" target="_blank" rel="noopener">这里</a>。</p>
<h3 id="初始化服务客户端"><a href="#初始化服务客户端" class="headerlink" title="初始化服务客户端"></a>初始化服务客户端</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const  mapboxClient &#x3D; mapboxSdk(&#123; accessToken: mapboxToken.token &#125;);</span><br></pre></td></tr></table></figure>
<p>mapboxSdk就是mapbox-sdk-js。这里传入了账号对应的token字符串，接下来可以根据名称直接获取对应的服务。</p>
<p>PS，如果是引用单个服务的应的js文件，每个服务也可以单独构建。譬如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">const mbxGeocoding &#x3D; require(&#39;@mapbox&#x2F;mapbox-sdk&#x2F;services&#x2F;geocoding&#39;);</span><br><span class="line">import &#123;</span><br><span class="line">    token</span><br><span class="line">&#125; from &#39;.&#x2F;Token&#39;;</span><br><span class="line"></span><br><span class="line">var mapboxGeocodingClient &#x3D; mbxGeocoding(&#123;</span><br><span class="line">    accessToken: token</span><br><span class="line">&#125;);</span><br><span class="line">mapboxGeocodingClient</span><br><span class="line">                .forwardGeocode(</span><br><span class="line">                ....</span><br><span class="line">                )</span><br><span class="line">                ....</span><br></pre></td></tr></table></figure>

<h2 id="地址转换为坐标"><a href="#地址转换为坐标" class="headerlink" title="地址转换为坐标"></a>地址转换为坐标</h2><p>同上一个例子类似，调用<code>geocoding.reverseGeocode</code>方法可以得到地址对应的坐标。</p>
<h3 id="第一步：检索城市的坐标"><a href="#第一步：检索城市的坐标" class="headerlink" title="第一步：检索城市的坐标"></a>第一步：检索城市的坐标</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">let searchCities&#x3D;function(cities, callBack) &#123;</span><br><span class="line">		cleanCityMarkers();</span><br><span class="line">	    let promiseArr &#x3D; cities.map(item &#x3D;&gt; &#123;</span><br><span class="line">	        return new Promise((resolve, reject) &#x3D;&gt; &#123;</span><br><span class="line">	        	mapboxClient.geocoding</span><br><span class="line">	                .forwardGeocode(&#123;</span><br><span class="line">	                    query: item.enName,</span><br><span class="line">	                    countries: [item.countryCode],</span><br><span class="line">	                    autocomplete: false,</span><br><span class="line">	                    limit: 1,</span><br><span class="line">	                    language:[&#39;zh-Hans&#39;,&#39;en&#x2F;&#x2F; 指定返回的地址名称，包括中文和英文，影响结果中feature.text的值</span><br><span class="line">	                &#125;)</span><br><span class="line">	                .send()</span><br><span class="line">	                .then(function(response) &#123;</span><br><span class="line">	                    if (</span><br><span class="line">	                        response &amp;&amp;</span><br><span class="line">	                        response.body &amp;&amp;</span><br><span class="line">	                        response.body.features &amp;&amp;</span><br><span class="line">	                        response.body.features.length</span><br><span class="line">	                    ) &#123;</span><br><span class="line">	                        var feature &#x3D; response.body.features[0];</span><br><span class="line">	                        resolve(</span><br><span class="line">	                        		&#123; center:feature.center,</span><br><span class="line">	                        			text:feature.text</span><br><span class="line">	                        			&#125;);</span><br><span class="line">	                    &#125; else &#123;</span><br><span class="line">	                        resolve(null);</span><br><span class="line">	                    &#125;</span><br><span class="line">	                &#125;);</span><br><span class="line">	        &#125;);</span><br><span class="line">	    &#125;);</span><br><span class="line">	    Promise.all(promiseArr).then(function(pCenters) &#123;</span><br><span class="line">	        callBack(pCenters);</span><br><span class="line">	    &#125;);</span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>
<p>这里的参数<code>queryStr</code>类似：London，GB这样的格式。如果有多个地点需要查询，这个接口也支持，但是需要对你的账号付费才行，价格参看<a href="https://www.mapbox.com/pricing/#permanentgeocode" target="_blank" rel="noopener">这里</a>。免费使用的例子就如上面代码一样。上面的例子中，执行完所有的查询后执行传入的回调函数，当然也可以返回Promise。</p>
<p>访问mapbox的此类服务，你需要<a href="https://github.com/mapbox/mapbox-sdk-js/blob/master/docs/services.md#forwardgeocode" target="_blank" rel="noopener">在sdk文档</a>和<a href="https://docs.mapbox.com/api/search/#forward-geocoding" target="_blank" rel="noopener">服务参数</a>两份文档之间来回查看。目前sdk并未支持接口所有的参数。</p>
<h3 id="第二步：在地图上绘制行程路线"><a href="#第二步：在地图上绘制行程路线" class="headerlink" title="第二步：在地图上绘制行程路线"></a>第二步：在地图上绘制行程路线</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">let getDirections&#x3D;function(centers,map)&#123;</span><br><span class="line">		let cityCenters &#x3D; centers.map(item &#x3D;&gt; &#123;</span><br><span class="line">            return &#123;</span><br><span class="line">                coordinates: item.center,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">		mapboxClient.directions.getDirections(&#123;</span><br><span class="line">            &#x2F;&#x2F; profile: &#39;driving-traffic&#39;,&#x2F;&#x2F; 这个选项只支持最多三个点</span><br><span class="line">            profile: &#39;driving&#39;,</span><br><span class="line">            waypoints: cityCenters,</span><br><span class="line">            geometries: &quot;geojson&quot;,</span><br><span class="line">        &#125;)</span><br><span class="line">        .send()</span><br><span class="line">        .then(response &#x3D;&gt; &#123;</span><br><span class="line">            var directions &#x3D; response.body;</span><br><span class="line">            var data &#x3D; directions.routes[0];</span><br><span class="line">            var route &#x3D; data.geometry.coordinates;</span><br><span class="line">            var geojson &#x3D; &#123;</span><br><span class="line">                &#39;type&#39;: &#39;Feature&#39;,</span><br><span class="line">                &#39;properties&#39;: &#123;&#125;,</span><br><span class="line">                &#39;geometry&#39;: &#123;</span><br><span class="line">                    &#39;type&#39;: &#39;LineString&#39;,</span><br><span class="line">                    &#39;coordinates&#39;: route</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            &#x2F;&#x2F; if the route already exists on the map, we&#39;ll reset it using setData</span><br><span class="line">            if (map.getSource(&#39;route&#39;)) &#123;</span><br><span class="line">                map.getSource(&#39;route&#39;).setData(geojson);</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; otherwise, we&#39;ll make a new request</span><br><span class="line">            else &#123;</span><br><span class="line">                map.addLayer(&#123;</span><br><span class="line">                    &#39;id&#39;: &#39;route&#39;,</span><br><span class="line">                    &#39;type&#39;: &#39;line&#39;,</span><br><span class="line">                    &#39;source&#39;: &#123;</span><br><span class="line">                        &#39;type&#39;: &#39;geojson&#39;,</span><br><span class="line">                        &#39;data&#39;: &#123;</span><br><span class="line">                            &#39;type&#39;: &#39;Feature&#39;,</span><br><span class="line">                            &#39;properties&#39;: &#123;&#125;,</span><br><span class="line">                            &#39;geometry&#39;: &#123;</span><br><span class="line">                                &#39;type&#39;: &#39;LineString&#39;,</span><br><span class="line">                                &#39;coordinates&#39;: geojson</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#39;layout&#39;: &#123;</span><br><span class="line">                        &#39;line-join&#39;: &#39;round&#39;,</span><br><span class="line">                        &#39;line-cap&#39;: &#39;round&#39;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#39;paint&#39;: &#123;</span><br><span class="line">                        &#39;line-color&#39;: &#39;blue&#39;,</span><br><span class="line">                        &#39;line-width&#39;: 5,</span><br><span class="line">                        &#39;line-opacity&#39;: 0.75</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            if (map.getSource(&#39;route&#39;)) &#123;</span><br><span class="line">                map.getSource(&#39;route&#39;).setData(geojson);</span><br><span class="line">                var coordinates &#x3D; geojson.geometry.coordinates;</span><br><span class="line">                var bounds &#x3D; coordinates.reduce(function(bounds, coord) &#123;</span><br><span class="line">                    &#x2F;* reduce语法：array1.reduce(callbackfn[, initialValue])  callbackfn语法：function callbackfn(previousValue, currentValue, currentIndex, array1)，这里整个语句的含义是以坐标0为初始值，边界逐渐扩展边界到最后一个坐标 *&#x2F;</span><br><span class="line">                    return bounds.extend(coord);</span><br><span class="line">                    &#x2F;* extend  (obj):包含给定的经纬度或者经纬度边界来扩展区域边界 *&#x2F;</span><br><span class="line">                &#125;, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0])); &#x2F;*new LngLatBounds(sw: [LngLatLike], ne: [LngLatLike]):创建LngLatBounds的构造器，LngLatBounds对象表示一个地理上有界限的区域，使用西南和东北的点的经纬坐标表示  *&#x2F;</span><br><span class="line">                map.fitBounds(bounds, &#123;</span><br><span class="line">                    &#x2F;*fitBounds(bounds,[options],[eventData])：移动缩放地图来将某个可视化区域包含在指定的地理边界内部，最终也会使用最高的zoomlevel来显示可视化区域试图  *&#x2F;</span><br><span class="line">                    padding: 100</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法请求了多点间的导航信息，在得到返回值（一系列点）后，尝试在地图上新加了一层，用得到的数据在这层上绘制了导航路径。最后控制地图缩放定位到正好完全显示导航路径的为位置。</p>
<h2 id="检索内容，获得静态地图图片"><a href="#检索内容，获得静态地图图片" class="headerlink" title="检索内容，获得静态地图图片"></a>检索内容，获得静态地图图片</h2><p>这个功能在java服务端实现，需要介绍下这边的sdk情况。总体来说这个sdk和js那边一样，都是要组合一些参数，请求一个mapbox服务得到结果。sdk底层使用了<a href="https://github.com/square/okhttp/tree/master/okhttp/src/main/java/okhttp3" target="_blank" rel="noopener">okhttp3</a>和<a href="https://square.github.io/retrofit/" target="_blank" rel="noopener">retrofit2</a>，两者结合把网络请求操作简化了。代码风格类似如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public static String getStaticImageURL(List&lt;String&gt; citiesList) throws IOException  &#123;</span><br><span class="line">		if(citiesList&#x3D;&#x3D;null||citiesList.size()&#x3D;&#x3D;0) &#123;</span><br><span class="line">			return Const.MAPBOX_DEFAULT_STATIC_IMAGE_URL;</span><br><span class="line">		&#125;</span><br><span class="line">		&#x2F;&#x2F; 存储附加在地图上的标注点</span><br><span class="line">		List&lt;StaticMarkerAnnotation&gt; markerList&#x3D;new ArrayList&lt;StaticMarkerAnnotation&gt;();</span><br><span class="line">		for(int i&#x3D;0;i&lt;citiesList.size();i++) &#123;</span><br><span class="line">			String queryStr&#x3D;citiesList.get(i);</span><br><span class="line">			queryStr&#x3D;queryStr.replaceAll(&quot;\\[|\\]&quot;, &quot;&quot;);</span><br><span class="line">			MapboxGeocoding client &#x3D; MapboxGeocoding.builder()</span><br><span class="line">					.accessToken(Const.MAPBOX_API_KEY)</span><br><span class="line">					.query(queryStr)</span><br><span class="line">					.baseUrl(&quot;https:&#x2F;&#x2F;api.mapbox.com&#x2F;geocoding&#x2F;v5&#x2F;&quot;)</span><br><span class="line">					.build();</span><br><span class="line">			&#x2F;&#x2F; 同步请求数据，另外有异步请求数据方法enqueue</span><br><span class="line">			Response&lt;GeocodingResponse&gt; response&#x3D;client.executeCall();</span><br><span class="line">			List&lt;CarmenFeature&gt; results &#x3D; response.body().features();</span><br><span class="line">			if (results.size() &gt; 0) &#123;</span><br><span class="line">			  Point firstResultPoint &#x3D; results.get(0).center();</span><br><span class="line">			  StaticMarkerAnnotation marker&#x3D;StaticMarkerAnnotation.builder()</span><br><span class="line">						.lnglat(firstResultPoint)</span><br><span class="line">						.label((i+1)+&quot;&quot;)</span><br><span class="line">						.color(255, 0, 0)</span><br><span class="line">						.build();</span><br><span class="line">				markerList.add(marker);</span><br><span class="line">			&#125; else &#123;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		MapboxStaticMap staticImage &#x3D; MapboxStaticMap.builder()</span><br><span class="line">				.accessToken(Const.MAPBOX_API_KEY)</span><br><span class="line">				.styleId(&quot;streets-v9&quot;)</span><br><span class="line">				.cameraAuto(true)&#x2F;&#x2F; 做了这个设置，自动达到最佳效果，地图中心点和缩放度量都失效</span><br><span class="line">				.width(653) &#x2F;&#x2F; Image width</span><br><span class="line">				.height(837) &#x2F;&#x2F; Image height</span><br><span class="line">				.staticMarkerAnnotations(markerList)</span><br><span class="line">				.build();</span><br><span class="line">		return staticImage.url().toString();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>以上代码分为两部分，第一部分同步请求城市的坐标，根据返回结果生成一组标记点信息，第二部分生成一个请求，这个请求中附带了上述生成的标记点信息，最后这个请求没有被发送，而是转换成为了一个url，供程序的其他部分使用。</p>
<p>这里需要特别注意的是对于免费用户，生成图片的次数受到限制，参见<a href="https://www.mapbox.com/pricing/#glstatic" target="_blank" rel="noopener">这里</a></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>使用mapbox构建自己的网站或者应用，更像是购买零件攒一台机器，可能你想要的零件都有，但你得耐心寻找，另外零件也应该在快速更新。</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/12/03/%E5%AE%B6%E7%94%A8%E6%89%93%E5%8D%B0%E6%9C%BA%E9%80%89%E8%B4%AD/" rel="prev" title="家用打印机选购">
      <i class="fa fa-chevron-left"></i> 家用打印机选购
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/03/15/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E6%8E%A5%E5%85%A5%E8%AE%B0%E5%BD%95/" rel="next" title="微信支付接入记录">
      微信支付接入记录 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#突如其来"><span class="nav-number">1.</span> <span class="nav-text">突如其来</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#了解mapbox"><span class="nav-number">2.</span> <span class="nav-text">了解mapbox</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#选择关注的内容"><span class="nav-number">2.1.</span> <span class="nav-text">选择关注的内容</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#前端js的选择"><span class="nav-number">2.1.1.</span> <span class="nav-text">前端js的选择</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#后端java的选择"><span class="nav-number">2.1.2.</span> <span class="nav-text">后端java的选择</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实现细节"><span class="nav-number">3.</span> <span class="nav-text">实现细节</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#地图初始化"><span class="nav-number">3.1.</span> <span class="nav-text">地图初始化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#根据经纬度在地图上标点并显示"><span class="nav-number">3.2.</span> <span class="nav-text">根据经纬度在地图上标点并显示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#根据地名显示行程路线"><span class="nav-number">3.3.</span> <span class="nav-text">根据地名显示行程路线</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化服务客户端"><span class="nav-number">3.3.1.</span> <span class="nav-text">初始化服务客户端</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#地址转换为坐标"><span class="nav-number">3.4.</span> <span class="nav-text">地址转换为坐标</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#第一步：检索城市的坐标"><span class="nav-number">3.4.1.</span> <span class="nav-text">第一步：检索城市的坐标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第二步：在地图上绘制行程路线"><span class="nav-number">3.4.2.</span> <span class="nav-text">第二步：在地图上绘制行程路线</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#检索内容，获得静态地图图片"><span class="nav-number">3.5.</span> <span class="nav-text">检索内容，获得静态地图图片</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Vigo</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Vigo</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.7.2
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
